jQuery(function(d){var e,t,a,i=function(){if(window.postL10n=window.postL10n?postL10n:{},postL10n.publish=WP_Weixin_Broadcast.postL10n.publish,postL10n.publishOn=WP_Weixin_Broadcast.postL10n.publishOn,postL10n.publishOnFuture=WP_Weixin_Broadcast.postL10n.publishOnFuture,postL10n.publishOnPast=WP_Weixin_Broadcast.postL10n.publishOnPast,postL10n.published=WP_Weixin_Broadcast.postL10n.published,d(".post-type-wechat_broadcast_msg .subsubsub li.publish a").length){var e=d(d(".subsubsub li.publish a").html());d(".subsubsub li.publish a").html(window.postL10n.published+" "),d(".subsubsub li.publish a").append(e)}},n=d("ol.serialization").sortable({cardsSortableContainer:"serialization",delay:0,placeholder:'<li class="placeholder"><div class="card">'+WP_Weixin_Broadcast.broadcastMessageItemPlaceholder+"</div></li>",onDrop:function(e,t,a){var i=n.sortable("serialize").get().shift(),s=[],r=d("<li/>").css({height:0});d.each(i,function(e,t){s.push(t.id)}),d("#wechat_broadcast_item_ids").val(s.join(",")),a(e,t),e.before(r),r.detach(),a(e,t)}}),s=function(e){var t=e.text;if(e.element){var a=d(e.element);e.city=a.data("city")||e.city,e.country=a.data("country")||e.country,e.thumb=a.data("thumb")||e.thumb}(e.city||e.country)&&(e.city&&e.country?t+=" - "+e.city+", "+e.country:e.city?t+=" - "+e.city+", N/A":t+=" - N/A, "+e.country);var i=d('<span class="wp-weixin-broadcast-select-wp-users-result">'+t+"</span>");return i.attr("data-id",e.id),i.prepend('<img src="'+e.thumb+'" class="user-thumb" />'),i};if(WP_Weixin_Broadcast.limitCardItems=function(){8<=d(".message-item-container > li").length?d(".add-item-trigger").attr("disabled","disabled"):(WP_Weixin_Broadcast.canBroadcast||WP_Weixin_Broadcast.debug)&&d(".add-item-trigger").removeAttr("disabled")},WP_Weixin_Broadcast.isBroadcastDirty=function(){return 0!==d(".message-item-container .dirty").length},WP_Weixin_Broadcast.enableBroadcastSave=function(){WP_Weixin_Broadcast.isBroadcastDirty()||(d("#publish").removeAttr("disabled"),d("#save-post").removeAttr("disabled"),d("#wechat_preview").removeAttr("disabled"))},WP_Weixin_Broadcast.disableBroadcastSave=function(){d("#publish").attr("disabled","disabled"),d("#save-post").attr("disabled","disabled"),d("#wechat_preview").attr("disabled","disabled")},WP_Weixin_Broadcast.broadcastCardBuilder={},WP_Weixin_Broadcast.broadcastCardBuilder["card-article"]=function(e){var t=d("#wp_weixin_broadcast_message_item_template_container .card").clone();return t.find(".card-background-thumb").attr("style",'background-image: url("'+e.thumbCover+'");'),t.find(".card-background-full").attr("style",'background-image: url("'+e.fullCover+'");'),t.find(".card-title").html(e.text),t.addClass("card-article"),t.attr({"data-id":e.id,"data-type":e.type,"data-name":e.text}),t},d("body").hasClass("post-type-wechat_broadcast_msg")){if(WP_Weixin_Broadcast.canBroadcast)d("#publishing-action, .misc-pub-section.misc-pub-post-status, .edit-timestamp").css("visibility","visible");else{if(!WP_Weixin_Broadcast.debug){var r=["#publishing-action","#save-action",".misc-pub-section.misc-pub-post-status",".edit-timestamp",".card-actions","#howto-drag"].join(","),o=[".wp-weixin-broadcast-items-selector-container input",".wp-weixin-broadcast-send-ignore-reprint-container input",".wp-weixin-broadcast-items-selector-container button:not(.delete-item-trigger)","#titlewrap input"].join(",");d(r).remove(),d(o).attr("disabled","disabled")}d(".serialization").removeClass("serialization"),d("body").addClass("broadcasted")}"single"===WP_Weixin_Broadcast.screen&&WP_Weixin_Broadcast.isBroadcastMessage&&(d(".misc-pub-section.curtime.misc-pub-curtime").css("visibility","visible"),i()),"list"===WP_Weixin_Broadcast.screen&&(d('input[name="keep_private"]').parents("div.inline-edit-group:first").css("display","none"),i(),d(".subsubsub").css("visibility","visible")),d("#save-post").on("click",function(){d("#preview-action .spinner, .misc-pub-curtime, #publish").css("visibility","hidden"),d(".add-item-trigger").attr("disabled","disabled")}),d(".save-timestamp").one("click",function(){setTimeout(function(){i(),d("#timestamp").css("visibility","visible")},1e3)}),"publish"!==d("#original_post_status").val()&&d("#publish").on("click",function(e){window.confirm(WP_Weixin_Broadcast.broadcastMessageSubmitConfirm)?d("#original_publish").val()===d("#publish").val()&&d("#post-body-content").append(d('<input type="hidden" name="wechat_message_do_broadcast" value="1">')):(e.preventDefault(),e.stopPropagation())}),WP_Weixin_Broadcast.isBroadcastDirty()&&d(".dirty-notice").show(),d(".message-item-container").length&&!d(".message-item-container > li").length?(d(".message-item-placeholder-container").removeClass("hidden"),WP_Weixin_Broadcast.disableBroadcastSave()):d(".message-item-container").removeClass("hidden"),WP_Weixin_Broadcast.limitCardItems(),WP_Weixin_Broadcast.isBroadcastDirty()&&WP_Weixin_Broadcast.disableBroadcastSave(),d(".wp-weixin-broadcast-items-container").on("click",".message-item-placeholder-container",function(e){e.preventDefault(),d("#wp_weixin_broadcast_select_item").select2("open")}),d(".message-item-container").on("click",".delete-card",function(e){if(e.preventDefault(),window.confirm(WP_Weixin_Broadcast.broadcastMessageItemRemoveConfirm)){d(this).closest("li").remove(),d(".message-item-container li").length||(d(".message-item-container").addClass("hidden"),d("#howto-drag").addClass("hidden"),d(".message-item-placeholder-container").removeClass("hidden"),WP_Weixin_Broadcast.disableBroadcastSave()),WP_Weixin_Broadcast.limitCardItems(),WP_Weixin_Broadcast.enableBroadcastSave();var t=n.sortable("serialize").get().shift(),a=[];d.each(t,function(e,t){a.push(t.id)}),d("#wechat_broadcast_item_ids").val(a.join(","))}}),d("#wp_weixin_broadcast_select_item").select2({placeholder:WP_Weixin_Broadcast.broadcastSelectArticlePlaceholder,theme:"wp-weixin-broadcast-select",allowClear:!0,disabled:!WP_Weixin_Broadcast.canBroadcast&&!WP_Weixin_Broadcast.debug,templateSelection:function(e){var t=e.output?e.output:"card-article",a=(0,WP_Weixin_Broadcast.broadcastCardBuilder[t])(e),i=d('<div class="wp-weixin-broadcast-selected-item"></div>');return a.addClass("hidden"),i.append(a),i.append(e.text),i},templateResult:function(e){return e.id?(0,WP_Weixin_Broadcast.broadcastCardBuilder[e.output])(e):e.text},ajax:{url:WP_Weixin_Broadcast.ajax_url,dataType:"json",language:WP_Weixin_Broadcast.locale,cache:!1,type:"POST",data:function(e){return{q:e.term,page:e.page||1,action:"wp_weixin_broadcast_get_items",nonce:d("#wechat_broadcast_message_content_nonce").val()}},processResults:function(e){var a=[];return e&&e.success&&e.data&&d.each(e.data.items,function(e,t){a.push({id:t.id,text:t.title,output:t.output,type:t.type,thumbCover:t.thumbCover,fullCover:t.fullCover})}),{results:a,pagination:{more:e.data.more}}}}}),d(".add-item-trigger").removeClass("select2-ui-wait"),d(".add-item-trigger").on("click",function(e){if(e.preventDefault(),!d(this).attr("disabled")){var t=d("#wp_weixin_broadcast_select_item").select2("data").shift();if(t&&void 0!==t){var a=d(".wp-weixin-broadcast-selected-item .card").clone(),i=d("#wp_weixin_broadcast_message_item_template_container .message-item").clone();i.html(""),a.removeClass("hidden"),a.find(".card-actions").removeClass("hidden"),i.attr("data-id",a.attr("data-id")),a.removeAttr("data-id"),i.attr("data-name",a.attr("data-name")),a.removeAttr("data-name"),i.append(a),d(".message-item-container").append(i),d(".message-item-placeholder-container").hasClass("hidden")||d(".message-item-placeholder-container").addClass("hidden"),d(".message-item-container").hasClass("hidden")&&(d(".message-item-container").removeClass("hidden"),d("#howto-drag").removeClass("hidden")),WP_Weixin_Broadcast.enableBroadcastSave(),WP_Weixin_Broadcast.limitCardItems();var s=n.sortable("serialize").get().shift(),r=[];d.each(s,function(e,t){r.push(t.id)}),d("#wechat_broadcast_item_ids").val(r.join(","))}}}),d("#wechat_preview").on("click",function(e){e.preventDefault();var a=d(this),i=d("#post"),t={ids:d("#wechat_broadcast_item_ids").val(),postId:a.data("id"),previewFollowerIds:d("#wechat_broadcast_preview_followers_ids").val().split(",").map(function(e){return e.trim()}),previewFollowerIdType:d('input[name="wechat_broadcast_preview_followers_id_type"]:checked').val(),nonce:d("#wechat_broadcast_message_content_nonce").val(),action:"wp_weixin_broadcast_preview"};a.attr("disabled")||(a.attr("disabled","disabled"),d("#preview-action .spinner").css("visibility","visible"),d.ajax({url:WP_Weixin_Broadcast.ajax_url,type:"POST",data:t}).done(function(e){WP_Weixin_Broadcast.debug?(a.removeAttr("disabled"),d("#preview-action .spinner").css("visibility","hidden"),console.log(e)):(i.prepend('<input type="hidden" name="wechat_broadcast_doing_preview" value="1">'),i.submit())}).fail(function(e,t){WP_Weixin_Broadcast.debug?(a.removeAttr("disabled"),d("#preview-action .spinner").css("visibility","hidden"),console.log(t)):(i.prepend('<input type="hidden" name="wechat_broadcast_doing_preview" value="1">'),i.submit())}))}),d("#wechat_broadcast_preview_followers_ids").on("input",function(){var e=d(this).val(),t=d("#wechat_preview");e&&""!==e.replace(",","").trim()?d(".message-item-container > li").length&&t.removeAttr("disabled","disabled"):t.attr("disabled","disabled")}),d("#wechat_broadcast_preview_followers_ids").trigger("input"),d("#wechat_broadcast_status").on("click",function(e){e.preventDefault();var a=d(this),t={postId:a.data("id"),nonce:d("#wechat_broadcast_message_content_nonce").val(),action:"wp_weixin_broadcast_status"};a.attr("disabled")||(a.attr("disabled","disabled"),d("#broadcast-status-action .spinner").css("visibility","visible"),d.ajax({url:WP_Weixin_Broadcast.ajax_url,type:"POST",data:t}).done(function(e){if(a.removeAttr("disabled"),d("#broadcast-status-action .spinner").css("visibility","hidden"),e.success){var t=d("#latest-broadcast-status span");t.removeClass(),t.addClass(e.data.class),t.html(e.data.text),d("#latest-broadcast-status").removeClass("hidden")}else console.log(e);WP_Weixin_Broadcast.debug&&console.log(e)}).fail(function(e,t){a.removeAttr("disabled"),d("#broadcast-status-action .spinner").css("visibility","hidden"),WP_Weixin_Broadcast.debug&&console.log(t)}))}),d('select[name="wechat_broadcast_target_type"').on("change",function(){var e=d(this).val();void 0!==e&&(d(".wp-weixin-broadcast-to-target-settings").hide(),d(".wp-weixin-broadcast-to-"+e).show(),"tag"===e?d("#wp_weixin_broadcast_select_broadcast_to_tag_id").val()||d("#publish").attr("disabled","disabled"):d(".message-item-container > li").length&&d("#publish").removeAttr("disabled","disabled"),"users"===e&&(1===d("#wp_weixin_broadcast_select_broadcast_to_wp_users").select2("data").length?d("#publish").attr("disabled","disabled"):d("#publish").removeAttr("disabled","disabled")))}),d("#wp_weixin_broadcast_select_broadcast_to_tag").select2({placeholder:WP_Weixin_Broadcast.broadcastSelectTagPlaceholder,theme:"wp-weixin-broadcast-select",allowClear:!0,disabled:!WP_Weixin_Broadcast.canBroadcast&&!WP_Weixin_Broadcast.debug,ajax:{url:WP_Weixin_Broadcast.ajax_url,dataType:"json",language:WP_Weixin_Broadcast.locale,cache:!1,type:"POST",data:function(e){return{q:e.term,page:e.page||1,action:"wp_weixin_broadcast_get_tags",nonce:d("#wechat_broadcast_message_content_nonce").val()}},processResults:function(e){var a=[];return e&&e.success&&e.data&&d.each(e.data,function(e,t){a.push({id:t.id,text:t.name+" ("+t.count+")"})}),{results:a}}}});var c=d(".wechat-broadcast-target-tag");c.length&&(e=d("#wp_weixin_broadcast_select_broadcast_to_tag"),t={id:c.data("id"),text:c.data("text")+" ("+c.data("number")+")"},a=new Option(t.text,t.id,!0,!0),e.append(a).trigger("change"),e.trigger({type:"select2:select",params:{data:t}})),d("#wp_weixin_broadcast_select_broadcast_to_tag").on("change",function(){var e=d("#wp_weixin_broadcast_select_broadcast_to_tag").select2("data").shift();e&&void 0!==e?(d("#wp_weixin_broadcast_select_broadcast_to_tag_id").val(e.id),d(".message-item-container > li").length&&d("#publish").removeAttr("disabled","disabled")):(d("#wp_weixin_broadcast_select_broadcast_to_tag_id").val(""),d("#publish").attr("disabled","disabled"))}),d("#wp_weixin_broadcast_select_broadcast_to_wp_users").select2({placeholder:WP_Weixin_Broadcast.broadcastSelectWPUsersPlaceholder,theme:"wp-weixin-broadcast-select",dropdownParent:d(".wp-weixin-broadcast-to-users"),cache:!0,closeOnSelect:!1,disabled:!WP_Weixin_Broadcast.canBroadcast&&!WP_Weixin_Broadcast.debug,templateSelection:function(e){return e.id?s(e):e.text},templateResult:function(e){return e.id?s(e):e.text},ajax:{url:WP_Weixin_Broadcast.ajax_url,dataType:"json",language:WP_Weixin_Broadcast.locale,cache:!1,type:"POST",data:function(e){return{q:e.term,page:e.page||1,action:"wp_weixin_broadcast_get_wp_wechat_users",nonce:d("#wechat_broadcast_message_content_nonce").val()}},processResults:function(e){var a=[];return e&&e.success&&e.data&&d.each(e.data.users,function(e,t){a.push({id:t.id,text:t.text,gender:t.gender,city:t.city,country:t.country,thumb:t.thumb})}),{results:a,pagination:{more:e.data.more}}}}}),d("#wp_weixin_broadcast_select_broadcast_to_wp_users").on("change",function(){var e=d("#wp_weixin_broadcast_select_broadcast_to_wp_users").select2("data");e&&void 0!==e?(1!==e.length?d("#publish").removeAttr("disabled","disabled"):d("#publish").attr("disabled","disabled"),e=d.map(e,function(e){return e.id}).join(","),d("#wp_weixin_broadcast_select_broadcast_to_wp_users_openids").val(e)):(d("#wp_weixin_broadcast_select_broadcast_to_wp_users_openids").val(""),d("#publish").attr("disabled","disabled"))}),d(".wechat-broadcast-target-user").length&&d(".wechat-broadcast-target-user").each(function(e,t){t=d(t);var a=d("#wp_weixin_broadcast_select_broadcast_to_wp_users"),i=new Option(t.data("text"),t.data("id"),!0,!0);i.title=t.data("text"),i.setAttribute("data-thumb",t.data("thumb")),i.setAttribute("data-gender",t.data("gender")),i.setAttribute("data-city",t.data("city")),i.setAttribute("data-country",t.data("country")),a.append(i).trigger("change"),a.trigger({type:"select2:select",params:{data:{id:t.data("id"),text:t.data("text"),gender:t.data("gender"),city:t.data("city"),country:t.data("country"),thumb:t.data("thumb")}}})}),d(".select2-ui-wait").removeClass("select2-ui-wait"),d('select[name="wechat_broadcast_target_type"').trigger("change"),d("#wechat_broadcast_log_container").on("click",".card",function(e){e.preventDefault();var t=d(this);d(".log-modal-backdrop").removeClass("hidden"),t.find(".log-full, .log-full .wechat-broadcast-message").removeClass("hidden")}),d(".log-full").on("click",".log-full-close",function(e){e.preventDefault(),e.stopPropagation(),d(".log-modal-backdrop, .log-full, .log-full .wechat-broadcast-message").addClass("hidden")}),d(".log-full").on("click",".log-full-details-container",function(e){e.stopPropagation()}),d(".message-item-container li.deleted").length===d(".message-item-container li").length?(d(".delete-item-trigger").attr("disabled","disabled"),d("#wp_weixin_broadcast_select_delete_item").attr("disabled","disabled")):d(".wp-weixin-broadcast-delete-article-trigger").on("click",function(e){if(e.preventDefault(),!d(this).attr("disabled")){var t=d("#wp_weixin_broadcast_select_delete_item").prop("selectedIndex"),a=d(this),i={action:"wp_weixin_broadcast_delete_remote_material",index:t,postId:a.data("id"),itemId:d("#wp_weixin_broadcast_select_delete_item").val(),nonce:d("#wechat_broadcast_message_content_nonce").val()};a.attr("disabled","disabled"),a.parent().find(".spinner").css("visibility","visible"),d.ajax({url:WP_Weixin_Broadcast.ajax_url,type:"POST",data:i}).done(function(e){WP_Weixin_Broadcast.debug?(a.removeAttr("disabled"),a.parent().find(".spinner").css("visibility","hidden"),console.log(e)):location.reload()}).fail(function(e,t){WP_Weixin_Broadcast.debug?(a.parent().find(".spinner").css("visibility","hidden"),a.removeAttr("disabled"),console.log(t)):location.reload()})}})}if(d("#wp_weixin_broadcast_h5_editor_wrap").length){WP_Weixin_Broadcast.updateH5EditorPreview=function(){var e=d("#wp_weixin_broadcast_h5_preview_frame"),t=e.contents().find(".rich_media_content"),a=e.contents().find(".rich_media_title"),i=e.contents().find(".rich_media_author"),s=d("#wechat_broadcast_article_author").val(),r=s.length?s:WP_Weixin_Broadcast.h5_preview_default_author;t&&(t.html(p()+b(l.codemirror.getValue())),a.html(d("#title").val()),i.html(r)),e.removeClass("busy")};var l=wp.codeEditor.initialize(d("#wp_weixin_broadcast_h5_editor_content"),WP_Weixin_Broadcast.editor_args),_=setTimeout(WP_Weixin_Broadcast.updateH5EditorPreview,300),u=d("#wp_weixin_broadcast_h5_editor_wrap"),p=function(){var e=d("#set-post-thumbnail img"),t="";return d("#wechat_broadcast_article_show_cover_image").prop("checked")&&(e.length?((t=d("<div>"+WP_Weixin_Broadcast.h5_preview_cover_image+"<div>")).find("img").attr("src",e.attr("src")),t=t.html()):t=WP_Weixin_Broadcast.h5_preview_cover_image),t},b=function(e){var t=document.createElement("div");t.innerHTML=e;for(var a=[t.getElementsByTagName("script"),t.getElementsByTagName("style"),t.getElementsByTagName("input"),t.getElementsByTagName("canvas"),t.getElementsByTagName("iframe"),t.getElementsByTagName("select")],i=a.length-1;0<=i;i--)for(;a[i][0];)a[i][0].parentNode.removeChild(a[i][0]);return t.innerHTML},m=!1,h=!1,w=d("#wp_weixin_broadcast_h5_editor_wrap"),g=d("#wp_weixin_broadcast_h5_preview_resizer"),v=d("#wp_weixin_broadcast_h5_editor_content_wrap"),x=function(){if(window.matchMedia("(min-width: 680px)").matches){var e=g.width(),t=w.width();v.width(t-e-25)}else v.removeAttr("style")};window.addEventListener("resize",function(){clearTimeout(h),m&&!h||(m=!0,h=setTimeout(x,201),setTimeout(function(){m=!1},200))}),d(".wp-weixin-broadcast-editor-switch").on("click",function(e){e.preventDefault();var t=d("#content-html"),a=d("#wp_weixin_broadcast_h5_preview_frame").contents(),i=a.find("body"),s=d("#postdivrich");t.trigger("click"),d("#wp_weixin_broadcast_h5_editor_wrap").hasClass("active")?(t.trigger("click"),d("#content").val(b(l.codemirror.getValue())),s.show(),u.removeClass("active"),d(window).scrollTop(d(window).scrollTop()+1),d(window).scrollTop(d(window).scrollTop()-1)):(a.find("head").html(WP_Weixin_Broadcast.h5_preview_head),i.addClass("mm_appmsg discuss_tab appmsg_skin_default appmsg_style_default not_in_mm"),s.hide(),u.addClass("active"),x(),l.codemirror.setValue(d("#content").val()),l.codemirror.refresh(),i.html(WP_Weixin_Broadcast.h5_preview_default_content),i.find(".rich_media_content").html(p()+b(l.codemirror.getValue())))}),l.codemirror.on("change",function(){var e=d("#wp_weixin_broadcast_h5_preview_frame");e.hasClass("busy")||(e.addClass("busy"),clearTimeout(_),setTimeout(WP_Weixin_Broadcast.updateH5EditorPreview,300))}),d("#title, #wechat_broadcast_article_author").on("keyup",function(){var e=d("#wp_weixin_broadcast_h5_preview_frame");e.hasClass("busy")||(e.addClass("busy"),clearTimeout(_),setTimeout(WP_Weixin_Broadcast.updateH5EditorPreview,300))}),d("#postimagediv").on("change","#wechat_broadcast_article_show_cover_image",function(){d("#wp_weixin_broadcast_h5_preview_frame").addClass("busy"),clearTimeout(_),setTimeout(WP_Weixin_Broadcast.updateH5EditorPreview,300)}),d(document).ajaxComplete(function(e,t,a){if("string"!=typeof a.data||!a.data.includes("heartbeat")){var i=d("#wp_weixin_broadcast_h5_preview_frame");i.hasClass("busy")||(i.addClass("busy"),clearTimeout(_),setTimeout(WP_Weixin_Broadcast.updateH5EditorPreview,300))}}),d("#publish").on("click",function(){u.hasClass("active")&&(d(".h5-active-button").trigger("click"),d(".h5-inactive-button").trigger("click"))}),d("#content-tmce").on("click",function(e){window.confirm(WP_Weixin_Broadcast.h5_visual_alert)||(e.preventDefault(),e.stopPropagation())})}});